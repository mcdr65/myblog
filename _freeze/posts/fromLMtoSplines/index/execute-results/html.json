{
  "hash": "161d043300ace2035aacfeeef2d9401b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Beyond linearity\"\ndate: \"2022-10-06\"\ndescription: \"From linear model to GAM\"\ncategories: [code, analysis]\n---\n\n\n\n\n\n\n## Example Data\n\nTriceps skinfold thickness dataset: The data are derived from an anthropometric study of 892 females under 50 years in three Gambian villages in West Africa.\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nlibrary(MultiKink)\nlibrary(ggplot2)\nlibrary(psych)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'psych'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:ggplot2':\n\n    %+%, alpha\n```\n\n\n:::\n:::\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ndata(\"triceps\")\nheadTail(triceps)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|    |age   |lntriceps |triceps |\n|:---|:-----|:---------|:-------|\n|1   |12.05 |1.22      |3.4     |\n|2   |9.91  |1.39      |4       |\n|3   |10.04 |1.44      |4.2     |\n|4   |11.49 |1.44      |4.2     |\n|... |...   |...       |...     |\n|889 |7.91  |1.92      |6.8     |\n|890 |7.99  |1.44      |4.2     |\n|891 |14.63 |2.2       |9       |\n|892 |30.14 |2.1       |8.2     |\n\n</div>\n:::\n\n```{.r .cell-code}\ntri.age.plot <- ggplot(triceps, aes(x=age, y=triceps)) +\n                 geom_point(alpha=0.55, color=\"black\") + \n                 theme_minimal() \ntri.age.plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n## Polynomial regression\n\nUsing `poly()` in `lm()`:\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nmodel.cubic.poly <- lm(triceps~poly(age,3,raw=TRUE),data=triceps)\n## the same model:\n## model.cubic <- lm(triceps~age + I(age^2) + I(age^3),\n##                   data=triceps)\ntri.age.plot + \n   stat_smooth(method = \"lm\", \n               formula = y~poly(x,3,raw=T), size = 1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nâ„¹ Please use `linewidth` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/polynomial-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n## Cross-validation of different polynomials\n\n### RMSE for quadratic\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nlibrary(caret)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: lattice\n```\n\n\n:::\n\n```{.r .cell-code}\nset.seed(1234)\ntrC.lm <- trainControl(method = \"repeatedcv\", \n                       number = 10,         \n                       repeats = 10)        \npol.model <- train(triceps ~ poly(age,3),\n                       data = triceps, \n                       method = \"lm\",\n                       trControl = trC.lm)    \npol.model$results[2]\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|  RMSE|\n|-----:|\n| 3.866|\n\n</div>\n:::\n:::\n\n\n\n\n### RMSE for different degrees\n\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nmy.pol.f <- function(x){\n    xx<-poly(triceps$age, x, raw=T)    \n    new.data  <- cbind(triceps=triceps$triceps, xx)                                 \n    pol.model <- train(triceps~., data = new.data,method = \"lm\")    \n    RMSE.cv = pol.model$results[2]\n  }\n\nt(sapply(1:10, my.pol.f))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     RMSE  RMSE  RMSE RMSE  RMSE  RMSE  RMSE  RMSE  RMSE  RMSE \n[1,] 3.985 4.083 3.83 3.776 3.787 3.741 3.847 3.803 3.867 3.804\n```\n\n\n:::\n:::\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ntri.age.plot + \n   stat_smooth(method = \"lm\", \n               formula = y~poly(x,6,raw=T), size = 1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Piecewise linear regression\n\nInstead of fitting a high-degree polynomial over the entire range of $X$, piecewise polynomial regression involves fitting separate low-degree polynomials\nover different regions of $X$. For example, a piecewise cubic polynomial works\nby fitting a cubic regression model of the form \n\n$$Y_i=\\beta_0+\\beta_1x_i+\\beta_2x_i^2+\\beta_3x_i^3+\\epsilon_i,$$ \n\nwhere the coefficients differ in different parts of the range of $X$. The points where the coefficients change are called *knots* $\\xi_k$, $k=1,\\dots,K$.\n\nLet us begin with a piecewise linear (degree=1):\n\n\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\npred1 <- predict(lm(triceps~age, \n                    data = triceps[triceps$age<5,]))\npred2 <- predict(lm(triceps~age, \n                    data = triceps[triceps$age >=5 & triceps$age<10,]))\npred3 <- predict(lm(triceps~age, \n                    data = triceps[triceps$age>=10 & triceps$age<20,]))\npred4 <- predict(lm(triceps~age, \n                    data = triceps[triceps$age>=20 & triceps$age<30,]))\npred5 <- predict(lm(triceps~age, \n                    data = triceps[triceps$age>=30 & triceps$age<40,]))\npred6 <- predict(lm(triceps~age, \n                    data = triceps[triceps$age>=40,]))\ntri.age.plot + \n  geom_line(data=triceps[triceps$age<5,], \n            aes(y = pred1, x=age), size = 1, col=\"blue\") +\n  geom_line(data=triceps[triceps$age >=5 & triceps$age<10,], \n            aes(y = pred2, x=age), size = 1, col=\"blue\") +\n  geom_line(data=triceps[triceps$age>=10 & triceps$age<20,], \n            aes(y = pred3, x=age), size = 1, col=\"blue\") +\n  geom_line(data=triceps[triceps$age>=20 & triceps$age<30,], \n            aes(y = pred4, x=age), size = 1, col=\"blue\") +\n  geom_line(data=triceps[triceps$age>=30 & triceps$age<40,], \n            aes(y = pred5, x=age), size = 1, col=\"blue\") +\n  geom_line(data=triceps[triceps$age>=40,], \n            aes(y = pred6, x=age), size = 1, col=\"blue\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n### Continuous piecewise linear regression\n\nWe want a continuous function. Let us define a *truncated power basis function* (here of degree=1) per knot $\\xi$,\n\n$$h(x, \\xi)=(x-\\xi)^1_{+}=\n\\begin{cases}\n  x-\\xi, \\text{\\,if\\,} x>\\xi\\\\\n  0, \\text{\\,else}.\n\\end{cases}\n$$ \n\nThe continuous piecewise regression equation is\n\n$$Y_i=\\beta_0+\\beta_1x_i+\\beta_2 h(x_i,5)+\\cdots+\\beta_6 h(x_i,40) + \\epsilon_i$$\n\n\nThis can be done -by hand- or with B-splines `splines::bs()`\n\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\npred7 <- predict(lm(triceps~ age + I((age-5)*(age>=5)) +\n                                   I((age-10)*(age >= 10)) +\n                                   I((age-20)*(age >= 20)) +\n                                   I((age-30)*(age >= 30)) +\n                                  I((age-40)*(age >= 40)),\n                    data = triceps))\nlibrary(splines)\npred.lm.bs <- predict(lm(triceps ~ bs(age, knots = c(5,10,20,30,40),degree=1), data=triceps))\ntri.age.plot +\n  geom_line(data=triceps, \n            aes(y = pred.lm.bs, x=age), size = 1, col=\"blue\")+\n  geom_line(data=triceps, \n            aes(y = pred7+.2, x=age), size = 1, col=\"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n<!-- ## Piecewise quadratic polynomial -->\n\n\n\n\n\n\n\n\n\n\n\n\n## Splines\n\n### Quadratic spline\n\nWith \n\n$$h(x, \\xi)=(x-\\xi)_{+}^2=\n\\begin{cases}\n  (x-\\xi)^2, \\text{\\,if\\,} x>\\xi\\\\\n  0, \\text{\\,else},\n\\end{cases}\n$$\n\nwe have as regression equation \n$$Y_i=\\beta_0+\\beta_1x_i+\\beta_2x_i^2+\\beta_3 h(x_i,5)+\\cdots+\\beta_7 h(x_i,40) + \\epsilon_i$$\n\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\npred.quadsmooth <- predict(lm(triceps~ age + I(age^2) + \n                    I((age-5)^2*(age>=5)) +\n                    I((age-10)^2*(age>=10)) +\n                    I((age-20)^2*(age>=20)) +\n                    I((age-30)^2*(age>=30)) +\n                    I((age-40)^2*(age>=40)),\n                    data = triceps))\npred.quadsmooth2 <- predict(lm(triceps ~ bs(age, knots = c(5,10,20,30,40),degree=2), data=triceps))                        \ntri.age.plot +\n  geom_line(data=triceps, \n            aes(y = pred.quadsmooth, x=age), size = 1, col=\"blue\")+\n  geom_line(data=triceps, \n            aes(y = pred.quadsmooth2+.2, x=age), size = 1, col=\"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### Cubic Spline\n\nMost often, cubic splines are used. Adding the following truncated power basis function per knot,\n\n$$h(x, \\xi)=(x-\\xi)_{+}^3=\n\\begin{cases}\n  (x-\\xi)^3, \\text{\\,if\\,} x>\\xi\\\\\n  0, \\text{\\,else},\n\\end{cases}\n$$\n\n\nto the model for a cubic polynomial will lead to a discontinuity in\n*only the third derivative* at $\\xi$; the function will remain continuous, with\n*continuous first and second derivatives, at each of the knots*:\n\n$$Y_i=\\beta_0+\\beta_1x_i+\\beta_2x_i^2+\\beta_3x_i^3+\\beta_4h(x_i,5)+\\cdots+\\beta_8h(x_i,40) + \\epsilon_i$$\n\nOne can show that a cubic spline has $K+4$ parameters.\n\n\n### Natural Spline\n\nNatural splines have an additional restriction that the fitted curve *linear at the extremes*, `splines::ns()`\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ncub.splines.bs <- lm(triceps ~ bs(age, knots = c(5,10,20,30,40)), data=triceps)\ncub.splines.ns <- lm(triceps ~ ns(age, knots = c(5,10,20,30,40)), data=triceps)\n```\n:::\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ntri.age.plot <- ggplot(triceps, aes(x=age, y=triceps)) +\n                 geom_point(alpha=0.55, color=\"black\") + \n                 theme_minimal() \ntri.age.plot +\n    stat_smooth(method = \"lm\", \n               formula = y~bs(x,knots = c(5,10,20,30,40)), \n               lty = 1, col = \"green\") + \n    stat_smooth(method = \"lm\", \n               formula = y~ns(x,knots = c(5,10,20,30,40)), \n               lty = 1, col = \"red\")\n```\n\n::: {.cell-output-display}\n![polynomial cubic splines (green), natural cubic splines (red)](index_files/figure-html/ns-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Smoothing splines\n\nAvoids the knot selection problem completely by using a maximal set of\nknots. The complexity of the fit is controlled by regularization.\nProblem: among all functions $f(x)$ with two continuous derivatives,\nfind one that minimizes the penalized residual sum of squares\n\n\n$$\n  RSS(f,\\lambda)=\\sum_{i=1}^N(y_i-f(x_i))^2+\\lambda[f''(t)]^2dt\n$$ {#eq-RSS}\n\n\n\nwhere $\\lambda$ is a fixed smoothing parameter. The first term measures closeness to the data, while the second term\npenalizes curvature in the function, and $\\lambda$ establishes a tradeoff\nbetween the two. Special cases: $\\lambda=0$ (no constraint on $f$) and\n$\\lambda=\\infty$ ($f$ has to be linear). \n\n\n\nThe function $f(x)$ that minimizes (@eq-RSS) can be shown to have some special properties: it is a piecewise cubic polynomial with knots at the unique\nvalues of $x_1,\\dots,x_n$ and continuous first and second derivatives at each\nknot. Furthermore, it is linear in the region outside of the extreme knots.\nIn other words, the function $f(x)$ that minimizes (@eq-RSS) is a natural cubic spline with knots at $x_1,\\dots,x_n$ ! However, it is not the same natural cubic spline that one would get if one applied the basis function approach described above -- rather, it is a shrunken version of such a natural cubic spline, where the value of the tuning parameter $\\lambda$ in (@eq-RSS) controls the level of shrinkage.\n\nSmoothing splines are implemented in `smooth.spline()`.\n\n\n### $\\lambda$ determined with cross-validation\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nsspline <- smooth.spline(x=triceps$age, y=triceps$triceps, cv=TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in smooth.spline(x = triceps$age, y = triceps$triceps, cv = TRUE): cross-validation with non-unique 'x' values seems doubtful\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(triceps$age, triceps$triceps)\nlines(sspline, lwd=3,col=\"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n### The extremes: no smooth and max smooth\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nssplineNosmooth <- smooth.spline(x=triceps$age, y=triceps$triceps, lambda=0)\nssplineMaxsmooth <- smooth.spline(x=triceps$age, y=triceps$triceps, lambda=100)\nplot(triceps$age, triceps$triceps)\nlines(ssplineNosmooth, lwd=2,col=\"red\")\nlines(ssplineMaxsmooth, lwd=2,col=\"blue\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-page}\n\n:::\n\n\n\n\n\n## Generalized additive model \n\nUsing `mgcv::gam()`\n\n\n\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nlibrary(mgcv)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: nlme\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThis is mgcv 1.9-1. For overview type 'help(\"mgcv-package\")'.\n```\n\n\n:::\n\n```{.r .cell-code}\ngamtri<-gam(triceps~s(age,bs=\"cr\"),data=triceps)\nsummary(gamtri)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ntriceps ~ s(age, bs = \"cr\")\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)\n(Intercept)    9.702      0.126    77.3   <2e-16\n\nApproximate significance of smooth terms:\n        edf Ref.df    F p-value\ns(age) 6.71   7.54 85.6  <2e-16\n\nR-sq.(adj) =  0.419   Deviance explained = 42.3%\nGCV =  14.18  Scale est. = 14.057    n = 892\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(gamtri)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/GAM-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}